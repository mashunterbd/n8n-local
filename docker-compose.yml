services:
  n8n:
    build: .
    container_name: n8n-local   # ‚úÖ Renamed from n8n-puppeteer
    restart: unless-stopped     # ‚úÖ Restart only if not manually stopped
    user: "1000:1000"           # ‚úÖ node user explicitly set
    ports:
      - "5678:5678"
    environment:
      - N8N_EDITOR_BASE_URL=http://localhost:5678
      - N8N_WEBHOOK_URL=http://localhost:5678/
      - N8N_SECURE_COOKIE=false

      # üîê Encryption key
      # - N8N_ENCRYPTION_KEY=G204euj9MgMh9vduXRVJPH2iy9pBtGU8 # Currently i'm not adding 

      # üóÇ Binary data handling
      - N8N_DEFAULT_BINARY_DATA_MODE=filesystem

      # üß© Enable all community features
      - N8N_COMMUNITY_PACKAGES_ALLOW_TOOL_USAGE=true
      - N8N_RUNNERS_ENABLED=true
      - N8N_LOG_LEVEL=debug
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true
      - EXECUTIONS_PROCESS=main
      - EXECUTIONS_DATA_SAVE_ON_ERROR=all
      - EXECUTIONS_DATA_SAVE_ON_SUCCESS=none
      - N8N_METRICS=true
      - N8N_FORMDATA_FILE_SIZE_MAX=1024
      - N8N_PAYLOAD_SIZE_MAX=256
      - TZ=Asia/Dhaka
      - GENERIC_TIMEZONE=Asia/Dhaka

      # ‚úÖ Restrict file access only to /shared (as per new n8n security model)
      - N8N_RESTRICT_FILE_ACCESS_TO=/shared

      # ‚úÖ Allow bare repositories for Git node (optional ‚Äî disable restriction)
      - N8N_GIT_NODE_DISABLE_BARE_REPOS=false

      # üß† Puppeteer config
      - PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser
      - PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
      - PUPPETEER_CACHE_DIR=/home/node/.cache/puppeteer
      - PUPPETEER_ARGS=--no-sandbox,--disable-setuid-sandbox

      # ‚úÖ Allow Node.js built-in modules
      - NODE_FUNCTION_ALLOW_BUILTIN=fs,crypto,path,os

      # ‚úÖ Enable disabled nodes
      - NODES_EXCLUDE=[]

      # ‚öôÔ∏è Optional: increase execution memory
      - NODE_OPTIONS=--max-old-space-size=4096

    volumes:
      # üîπ Persistent config & binary data
      - n8n_storage:/home/node/.n8n
      - n8n_binaries:/home/node/.n8n/binary_data

      # üîπ Shared folder for file read/write inside workflows
      - ./shared-data:/shared:rw

      # üîπ Mount external storage (optional)
      - /mnt/data:/mnt/data

    # ‚úÖ Automatically create /shared/tmp and /shared/pdf folders on startup
    entrypoint: /bin/sh -c "mkdir -p /shared/tmp /shared/pdf && exec n8n"

volumes:
  n8n_storage:
    driver: local
  n8n_binaries:
    driver: local
